import random

import sequre.lattiseq.ckks as ckks

from ..utils import assert_eq


def test_send_receive_ciphertext(mpc):
    ct = ckks.Ciphertext()
    received_ct = ckks.Ciphertext()

    if mpc.pid == 1:
        mpc.prg.switch_seed(2)
        values = [7 * random.random() for _ in range(mpc.he.crypto_params.params.slots())]
        mpc.prg.restore_seed(2)
        
        ct = mpc.he.encrypt_vector(values)[0][0]
        mpc.comms.send_ciphertext(ct, 2)
        received_ct = mpc.comms.receive_ciphertext(2)
    elif mpc.pid == 2:
        values = [7 * random.random() for _ in range(mpc.he.crypto_params.params.slots())]
        
        ct = mpc.he.encrypt_vector(values)[0][0]
        received_ct = mpc.comms.receive_ciphertext(1)
        mpc.comms.send_ciphertext(ct, 1)

    assert_eq("MHE send/receive ciphertext", ct, received_ct)


def test_collective_decryption(mpc):
    mpc.prg.switch_seed(-1)
    values = [7 * random.random() for _ in range(mpc.he.crypto_params.params.slots() * 2)]
    mpc.prg.restore_seed(-1)
    
    precision_stats = mpc.he.precision_stats(
        result=mpc.he.decode_vector(
            mpc.he.crypto_params,
            [mpc.he.collective_decrypt(
                mpc.he.crypto_params,
                mpc.he.encrypt_vector(values)[0][0],
                mpc.he.comms.hub_pid)],
            DTP=float),
        expected=values)
    
    assert_eq("MHE collective decryption", precision_stats.min_precision.l2 > 22, True)


def test_addition(mpc):
    mpc.prg.switch_seed(-1)
    values_1 = [7 * random.random() for _ in range(mpc.he.crypto_params.params.slots() * 2)]
    values_2 = [7 * random.random() for _ in range(mpc.he.crypto_params.params.slots() * 2)]
    mpc.prg.restore_seed(-1)

    ciphertext_1 = mpc.he.encrypt_vector(values_1)
    ciphertext_2= mpc.he.encrypt_vector(values_2)
    ciphertext_sum = mpc.he.add(ciphertext_1, ciphertext_2)

    precision_stats = mpc.he.precision_stats(
        params=mpc.he.crypto_params.params,
        result=mpc.he.decode_vector(
            mpc.he.collective_decrypt(
                mpc.he.crypto_params,
                ciphertext_sum,
                mpc.he.comms.hub_pid)),
        expected=values_1 + values_2)
    
    assert_eq("MHE addition", precision_stats.min_precision.l2 > 22, True)


def test_multiplication(mpc):
    mpc.prg.switch_seed(-1)
    values_1 = [7 * random.random() for _ in range(mpc.he.crypto_params.params.slots() * 2)]
    values_2 = [7 * random.random() for _ in range(mpc.he.crypto_params.params.slots() * 2)]
    mpc.prg.restore_seed(-1)

    ciphertext_1 = mpc.he.encrypt_vector(values_1)
    ciphertext_2= mpc.he.encrypt_vector(values_2)
    ciphertext_product = mpc.he.mult(ciphertext_1, ciphertext_2)

    precision_stats = mpc.he.precision_stats(
        params=mpc.he.crypto_params.params,
        result=mpc.he.decode_vector(mpc.he.collective_decrypt(mpc.he.crypto_params, ciphertext_product, mpc.he.comms.hub_pid)),
        expected=values_1 * values_2)
    
    assert_eq("MHE multiplication level", ciphertext_product.level(), ciphertext_1.level() - 1)
    assert_eq("MHE multiplication result", precision_stats.min_precision.l2 > 22, True)


def test_arithmetics(mpc):
    test_addition(mpc)
    test_multiplication(mpc)


def test_collective_bootstrapping(mpc):
    mpc.prg.switch_seed(-1)
    values = [7 * random.random() for _ in range(mpc.he.crypto_params.params.slots() * 2)]
    mpc.prg.restore_seed(-1)

    ciphertext = mpc.he.encrypt_vector(values)
    ciphertext_squared = mpc.he.mult(ciphertext, ciphertext)
    ciphertext_bootstrapped = mpc.collective_bootstrap(ciphertext_squared)

    precision_stats = mpc.he.precision_stats(
        params=mpc.he.crypto_params.params,
        result=mpc.he.decode_vector(mpc.he.decrypt_vector(ciphertext_bootstrapped)),
        expected=values ** 2)
    
    boot_lvl = ciphertext_bootstrapped.level()
    mult_level = ciphertext_squared.level()
    initial_lvl = ciphertext.level()

    assert_eq("MHE collective bootstrapping level", (boot_lvl - mult_level) * boot_lvl, initial_lvl)
    assert_eq("MHE collective bootstrapping result", precision_stats.min_precision.l2 > 22, True)


def test_mhe(mpc):
    print(f'CP{mpc.pid}:\tTesting MHE ... \n')

    ckks_params = ckks.new_parameters_from_literal(ckks.PN14QP438)
    mpc.he.set_params(ckks_params)
    mpc.he.collective_init(ckks_params, u64(256))
    test_send_receive_ciphertext(mpc)
    test_collective_decryption(mpc)
    # test_arithmetics(mpc)
    # test_collective_bootstrapping(mpc)

    print(f'CP{mpc.pid}:\tMHE tests passed.\n')
