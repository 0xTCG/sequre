import math

from ..utils import assert_eq, assert_eq_approx

import sequre.lattiseq.ckks as ckks

from sequre.lattiseq.stats import plot_precision_stats
from sequre.types.builtin import Complex


def test_encryp_decrypt(params):
    print('Initializing HE encoder ...')
    encoder = ckks.new_encoder_complex(params)
    print('Initializing HE keygen ...')
    kgen = ckks.new_key_generator(params)
    sk = kgen.gen_secret_key()
    print('Initializing HE encryptor ...')
    encryptor = ckks.new_encryptor(params, sk)
    print('Initializing HE decryptor ...')
    decryptor = ckks.new_decryptor(params, sk)

    values = [Complex(2 * math.pi, 0) for _ in range(params.slots())]
    
    print('Initializing HE plaintext ...')
    plaintext = ckks.new_plaintext(params, params.max_level(), params.default_scale / 16)

    print('Encoding values ...')
    encoder.encode(values, plaintext, params.log_slots)
    
    print('Encrypting values ...')
    ciphertext = encryptor.encrypt_new(plaintext)

    print('Evaluating precision ...')
    precision_stats = plot_precision_stats(params, ciphertext, values, decryptor, encoder)
    
    assert_eq("Homomorphic encryption/decryption", precision_stats.min_precision.l2 > 22, True)


def test_lattiseq():
    print('Testing Lattiseq ...')
    # Schemes parameters are created from scratch
    params = ckks.new_parameters_from_literal(
        ckks.ParametersLiteral(
            logn=14,
            logq=[55, 40, 40, 40, 40, 40, 40, 40],
            logp=[45, 45],
            log_slots=13,
            default_scale=float(1 << 40)))

    test_encryp_decrypt(params)


def test_he():
    print('Testing HE ...')
    test_lattiseq()
