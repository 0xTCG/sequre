from ..utils import assert_values

from sequre.utils.param import *
from sequre.mpc.env import MPCEnv
from .. import opal_protocol


def test_opal[TP](mpc: MPCEnv[TP], modulus: TP):
    with open('tests/data/output/opal.txt') as f:
        expected_output = [int(e.strip()) for e in f]
        result, dico = opal_protocol(mpc, True, modulus)
        result_revealed = [int(dico[int(e)]) for e in result.print(mpc)]

        # if mpc.pid:
        #     assert_values(
        #         f'Opal ({"ring" if modulus.popcnt() == 1 else "field"})',
        #         result_revealed, expected_output)

        print('Accuracy:', (result_revealed.numpy_eq(expected_output)).mean())

    print(f'Opal ({"ring" if modulus.popcnt() == 1 else "field"}) passed at {mpc.pid}!\n')
