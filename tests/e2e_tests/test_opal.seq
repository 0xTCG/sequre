from ..utils import assert_values, score_linear_classificator

from sequre.utils.param import *
from sequre.mpc.env import MPCEnv
from .. import opal_protocol


def test_opal[TP](mpc: MPCEnv[TP], modulus: TP):
    with open('tests/data/output/opal.txt') as f:
        result, dico = opal_protocol(mpc, True, modulus)
        true_values = [int(dico[int(e.strip())]) for e in f]
        accuracy, precision, recall = score_linear_classificator(result.print(mpc), true_values)

        print(f'Accuracy: {accuracy}. Precision: {precision}. Recall: {recall}')
        if mpc.pid != 0:
            assert_values('Opal accuracy', accuracy, 0.1)
            assert_values('Opal precision', precision, 0.1)
            assert_values('Opal recall', recall, 1.0)

    print(f'Opal ({"ring" if modulus.popcnt() == 1 else "field"}) passed at {mpc.pid}!\n')
